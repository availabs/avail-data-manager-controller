#!/usr/bin/env node

require("ts-node").register();
require("tsconfig-paths").register();

const yargs = require("yargs/yargs");
const { hideBin } = require("yargs/helpers");

const dama_events = require("data_manager/events").default;
const logger = require("data_manager/logger").default;
const { runInDamaContext } = require("data_manager/contexts");

const {
  default: etl,
  pg_env_yargs_config,
  file_path_yargs_config,
  logging_level_yargs_config,
} = require("data_utils/gis/etl");

const layer_name = "vw_LargeCulverts";

const source_info = {
  name: "nysdot_structures_culverts",
  display_name: "NYSDOT Structures: Culverts",
};

const view_info = {
  table_schema: "nysdot_structures",
  table_name: "culverts",
  source_url:
    "https://data.gis.ny.gov/datasets/9e038774ef034c7cae5374f3e23f7a67_0",
  publisher: "NYS Department of Transportation",
};

// function reviseTableDescriptor(table_descriptor) {
// for (const c of text_columns) {
// const column_type = table_descriptor.columnTypes.find(
// ({ col }) => col === c
// );

// console.log("==> column_name:", c);

// column_type.db_type = "TEXT";
// }

// return table_descriptor;
// }

const { pg_env, file_path, logging_level } = yargs(hideBin(process.argv))
  .strict()
  .options({
    file_path: file_path_yargs_config,
    pg_env: pg_env_yargs_config,
    logging_level: logging_level_yargs_config,
  }).argv;

logger.level = logging_level;

const config = {
  file_path,
  layer_name,
  source_info,
  view_info,
  // reviseTableDescriptor,
  preserve_text_fields: true,
};

async function main() {
  const etl_context_id = await dama_events.spawnEtlContext(null, null, pg_env);

  logger.info(`==> etl_context_id: ${etl_context_id}`);

  await runInDamaContext(
    {
      meta: { pgEnv: pg_env, etl_context_id },
    },
    () => etl(config)
  );
}

main();
